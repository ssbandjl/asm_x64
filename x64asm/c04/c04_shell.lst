     1                                  ;c04_shell.asm:系统外壳程序，2022-1-19。用于模拟一个操作系统用户接口，比如Linux控制台
     2                                  
     3                                  ;===============================================================================
     4                                  section shell_header                              ;外壳程序头部
     5 00000000 [B200000000000000]        length       dq shell_end                       ;#0：外壳程序的总长度（字节数）
     6 00000008 [AD00000000000000]        entry        dq start                           ;#8：外壳入口点
     7 00000010 0000000000000000          linear       dq 0                               ;#16：外壳加载的虚拟（线性）地址
     8                                  
     9                                  ;===============================================================================
    10                                  section shell_data                                ;外壳程序数据段
    11 00000000 4F53205348454C4C2D        shell_msg    db "OS SHELL-"
    12 00000009 00<rep 20h>               time_buff    times 32 db 0
    13                                  
    14                                  ;===============================================================================
    15                                  section shell_code                                ;外壳程序代码段
    16                                  
    17                                  %include "..\common\user_static64.lib"
    18                              <1> ;user_static64.lib:用户程序使用的例程库，用来模拟高级语言的静态库。有些功能直接在本文件
    19                              <1> ;中实现，但有些功能需要通过syscall指令使用内核提供的系统调用。
    20                              <1> ;创建时间：2022-01-30 18:30，李忠
    21                              <1> ;此文件需要用预处理指令%include引入用户程序。
    22                              <1> 
    23                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    24                              <1>          bits 64
    25                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    26                              <1> bin64_to_dec:                                     ;将二进制数转换为十进制字符串。
    27                              <1>                                                   ;输入：R8=64位二进制数
    28                              <1>                                                   ;      RBX=目标缓冲区线性地址
    29 00000000 50                  <1>          push rax
    30 00000001 53                  <1>          push rbx
    31 00000002 51                  <1>          push rcx
    32 00000003 52                  <1>          push rdx
    33 00000004 4150                <1>          push r8
    34                              <1> 
    35 00000006 490FBAE03F          <1>          bt r8, 63
    36 0000000B 7309                <1>          jnc .begin
    37 0000000D C6032D              <1>          mov byte [rbx], '-'
    38 00000010 49F7D8              <1>          neg r8
    39 00000013 48FFC3              <1>          inc rbx
    40                              <1>   .begin:
    41 00000016 4C89C0              <1>          mov rax, r8                              ;!!
    42 00000019 41B80A000000        <1>          mov r8, 10
    43 0000001F 4831C9              <1>          xor rcx, rcx
    44                              <1> 
    45                              <1>   .next_div:
    46 00000022 4831D2              <1>          xor rdx, rdx
    47 00000025 49F7F0              <1>          div r8
    48 00000028 52                  <1>          push rdx                                 ;保存分解的数位
    49 00000029 48FFC1              <1>          inc rcx                                  ;递增压栈的次数
    50 0000002C 4809C0              <1>          or rax, rax                              ;商为0？
    51 0000002F 7402                <1>          jz .rotate
    52 00000031 EBEF                <1>          jmp .next_div
    53                              <1> 
    54                              <1>   .rotate:
    55 00000033 5A                  <1>          pop rdx
    56 00000034 80C230              <1>          add dl, 0x30                             ;数位转换成ASCII编码
    57 00000037 8813                <1>          mov [rbx], dl
    58 00000039 48FFC3              <1>          inc rbx
    59 0000003C E2F5                <1>          loop .rotate
    60                              <1> 
    61 0000003E C60300              <1>          mov byte [rbx], 0
    62                              <1> 
    63 00000041 4158                <1>          pop r8
    64 00000043 5A                  <1>          pop rdx
    65 00000044 59                  <1>          pop rcx
    66 00000045 5B                  <1>          pop rbx
    67 00000046 58                  <1>          pop rax
    68                              <1> 
    69 00000047 C3                  <1>          ret                                      ;段内返回
    70                              <1> 
    71                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    72                              <1> string_concatenates:                              ;将源字符串连接到目的字符串的尾部
    73                              <1>                                                   ;输入：RSI=源字符串的线性地址
    74                              <1>                                                   ;      RDI=目的字符串的线性地址
    75 00000048 50                  <1>          push rax
    76 00000049 56                  <1>          push rsi
    77 0000004A 57                  <1>          push rdi
    78                              <1> 
    79                              <1>   .r0:
    80 0000004B 803F00              <1>          cmp byte [rdi], 0
    81 0000004E 7405                <1>          jz .r1
    82 00000050 48FFC7              <1>          inc rdi
    83 00000053 EBF6                <1>          jmp .r0
    84                              <1> 
    85                              <1>   .r1:
    86 00000055 8A06                <1>          mov al, [rsi]
    87 00000057 8807                <1>          mov [rdi], al
    88 00000059 3C00                <1>          cmp al, 0
    89 0000005B 7408                <1>          jz .r2
    90 0000005D 48FFC6              <1>          inc rsi
    91 00000060 48FFC7              <1>          inc rdi
    92 00000063 EBF0                <1>          jmp .r1
    93                              <1> 
    94                              <1>   .r2:
    95 00000065 5F                  <1>          pop rdi
    96 00000066 5E                  <1>          pop rsi
    97 00000067 58                  <1>          pop rax
    98                              <1> 
    99 00000068 C3                  <1>          ret
   100                              <1> 
   101                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   102                              <1> 
    18                                  
    19                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    20                                           bits 64
    21                                  
    22                                  main:
    23                                           ;这里可显示一个界面，比如Windows桌面或者Linux控制台窗口，用于接收用户输入的
    24                                           ;命令，包括显示磁盘文件、设置系统参数或者运行一个程序。我们的系统很简单，所以不
    25                                           ;提供这些功能。
    26                                  
    27                                           ;以下， 模拟按用户的要求运行3个程序......
    28 00000069 41B864000000                     mov r8, 100
    29 0000006F B803000000                       mov rax, 3
    30 00000074 0F05                             syscall
    31 00000076 0F05                             syscall
    32 00000078 0F05                             syscall                                  ;用同一个副本创建3个任务
    33                                  
    34 0000007A B800000000                       mov rax, 0
    35 0000007F 0F05                             syscall                                  ;可用显示行，DH=行号
    36 00000081 B200                             mov dl, 0
    37 00000083 41B15F                           mov r9b, 0x5f
    38                                  
    39 00000086 4C8B25(10000000)                 mov r12, [rel linear]
    40                                    _time:
    41 0000008D 498D9C24[09000000]               lea rbx, [r12 + time_buff]
    42 00000095 B801000000                       mov rax, 1
    43 0000009A 0F05                             syscall
    44                                  
    45 0000009C 498D9C24[00000000]               lea rbx, [r12 + shell_msg]
    46 000000A4 B802000000                       mov rax, 2
    47 000000A9 0F05                             syscall
    48                                  
    49 000000AB EBE0                             jmp _time
    50                                  
    51                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    52                                  start:    ;程序的入口点
    53 000000AD E8B7FFFFFF                       call main
    54                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    55                                  shell_end:

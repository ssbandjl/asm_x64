     1                                  ;c07_userapp.asm:多线程应用程序，李忠，2022-10-29
     2                                  
     3                                  ;===============================================================================
     4                                  section app_header                                ;应用程序头部
     5 00000000 [DE01000000000000]        length       dq app_end                         ;#0：用户程序的总长度（字节数）
     6 00000008 [D201000000000000]        entry        dq start                           ;#8：用户程序入口点
     7 00000010 0000000000000000          linear       dq 0                               ;#16：用户程序加载的虚拟（线性）地址
     8                                  
     9                                  ;===============================================================================
    10                                  section app_data                                  ;应用程序数据段
    11                                  
    12 00000000 5468726561642000          tid_prex     db "Thread ", 0                    ;线程标识前缀文本
    13 00000008 203C5461736B2000          pid_prex     db " <Task ", 0                    ;进程标识前缀文本
    14 00000010 3E206F6E2043505520-       cpu_prex     db "> on CPU ", 0                  ;处理器标识的前缀文本
    14 00000019 00                 
    15 0000001A 20646F20312B322B33-       delim        db " do 1+2+3+...+", 0             ;分隔文本
    15 00000023 2B2E2E2E2B00       
    16 00000029 3D00                      equal        db "=", 0                          ;等于号
    17                                  
    18                                  ;===============================================================================
    19                                  section app_code                                  ;应用程序代码段
    20                                  
    21                                  %include "..\common\user_static64.lib"
    22                              <1> ;user_static64.lib:用户程序使用的例程库，用来模拟高级语言的静态库。有些功能直接在本文件
    23                              <1> ;中实现，但有些功能需要通过syscall指令使用内核提供的系统调用。
    24                              <1> ;创建时间：2022-01-30 18:30，李忠
    25                              <1> ;此文件需要用预处理指令%include引入用户程序。
    26                              <1> 
    27                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    28                              <1>          bits 64
    29                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    30                              <1> bin64_to_dec:                                     ;将二进制数转换为十进制字符串。
    31                              <1>                                                   ;输入：R8=64位二进制数
    32                              <1>                                                   ;      RBX=目标缓冲区线性地址
    33 00000000 50                  <1>          push rax
    34 00000001 53                  <1>          push rbx
    35 00000002 51                  <1>          push rcx
    36 00000003 52                  <1>          push rdx
    37 00000004 4150                <1>          push r8
    38                              <1> 
    39 00000006 490FBAE03F          <1>          bt r8, 63
    40 0000000B 7309                <1>          jnc .begin
    41 0000000D C6032D              <1>          mov byte [rbx], '-'
    42 00000010 49F7D8              <1>          neg r8
    43 00000013 48FFC3              <1>          inc rbx
    44                              <1>   .begin:
    45 00000016 4C89C0              <1>          mov rax, r8                              ;!!
    46 00000019 41B80A000000        <1>          mov r8, 10
    47 0000001F 4831C9              <1>          xor rcx, rcx
    48                              <1> 
    49                              <1>   .next_div:
    50 00000022 4831D2              <1>          xor rdx, rdx
    51 00000025 49F7F0              <1>          div r8
    52 00000028 52                  <1>          push rdx                                 ;保存分解的数位
    53 00000029 48FFC1              <1>          inc rcx                                  ;递增压栈的次数
    54 0000002C 4809C0              <1>          or rax, rax                              ;商为0？
    55 0000002F 7402                <1>          jz .rotate
    56 00000031 EBEF                <1>          jmp .next_div
    57                              <1> 
    58                              <1>   .rotate:
    59 00000033 5A                  <1>          pop rdx
    60 00000034 80C230              <1>          add dl, 0x30                             ;数位转换成ASCII编码
    61 00000037 8813                <1>          mov [rbx], dl
    62 00000039 48FFC3              <1>          inc rbx
    63 0000003C E2F5                <1>          loop .rotate
    64                              <1> 
    65 0000003E C60300              <1>          mov byte [rbx], 0
    66                              <1> 
    67 00000041 4158                <1>          pop r8
    68 00000043 5A                  <1>          pop rdx
    69 00000044 59                  <1>          pop rcx
    70 00000045 5B                  <1>          pop rbx
    71 00000046 58                  <1>          pop rax
    72                              <1> 
    73 00000047 C3                  <1>          ret                                      ;段内返回
    74                              <1> 
    75                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    76                              <1> string_concatenates:                              ;将源字符串连接到目的字符串的尾部
    77                              <1>                                                   ;输入：RSI=源字符串的线性地址
    78                              <1>                                                   ;      RDI=目的字符串的线性地址
    79 00000048 50                  <1>          push rax
    80 00000049 56                  <1>          push rsi
    81 0000004A 57                  <1>          push rdi
    82                              <1> 
    83                              <1>   .r0:
    84 0000004B 803F00              <1>          cmp byte [rdi], 0
    85 0000004E 7405                <1>          jz .r1
    86 00000050 48FFC7              <1>          inc rdi
    87 00000053 EBF6                <1>          jmp .r0
    88                              <1> 
    89                              <1>   .r1:
    90 00000055 8A06                <1>          mov al, [rsi]
    91 00000057 8807                <1>          mov [rdi], al
    92 00000059 3C00                <1>          cmp al, 0
    93 0000005B 7408                <1>          jz .r2
    94 0000005D 48FFC6              <1>          inc rsi
    95 00000060 48FFC7              <1>          inc rdi
    96 00000063 EBF0                <1>          jmp .r1
    97                              <1> 
    98                              <1>   .r2:
    99 00000065 5F                  <1>          pop rdi
   100 00000066 5E                  <1>          pop rsi
   101 00000067 58                  <1>          pop rax
   102                              <1> 
   103 00000068 C3                  <1>          ret
   104                              <1> 
   105                              <1> ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   106                              <1> 
    22                                  
    23                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    24                                           bits 64
    25                                  
    26                                  thread_procedure:
    27 00000069 4889E5                           mov rbp, rsp                             ;RBP访问栈中数据，高级语言中的局部变量。
    28 0000006C 4883EC38                         sub rsp, 56
    29                                  
    30 00000070 B80A000000                       mov rax, 10                              ;分配内存
    31 00000075 BA20010000                       mov rdx, 288                             ;288个字节
    32 0000007A 0F05                             syscall
    33 0000007C 4C896DF8                         mov [rbp-8], r13                         ;RBP-8->总字符串缓冲区的线性地址
    34                                  
    35 00000080 4981C580000000                   add r13, 128
    36 00000087 4C896DF0                         mov [rbp-16], r13                        ;RBP-16->用来保存线程标识的文本
    37                                  
    38 0000008B 4983C520                         add r13, 32
    39 0000008F 4C896DE8                         mov [rbp-24], r13                        ;RBP-24->用来保存任务标识的文本
    40                                  
    41 00000093 4983C520                         add r13, 32
    42 00000097 4C896DE0                         mov [rbp-32], r13                        ;RBP-32->用来保存处理器编号的文本
    43                                  
    44 0000009B 4983C520                         add r13, 32
    45 0000009F 4C896DD8                         mov [rbp-40], r13                        ;RBP-40->用来保存加数的文本
    46                                  
    47 000000A3 4983C520                         add r13, 32
    48 000000A7 4C896DD0                         mov [rbp-48], r13                        ;RBP-48->用来保存累加和的文本
    49                                  
    50 000000AB B808000000                       mov rax, 8                               ;获得当前线程的标识
    51 000000B0 0F05                             syscall
    52 000000B2 4989C0                           mov r8, rax
    53 000000B5 488B5DF0                         mov rbx, [rbp-16]
    54 000000B9 E842FFFFFF                       call bin64_to_dec                        ;将线程标识转换为字符串
    55                                  
    56 000000BE B804000000                       mov rax, 4                               ;获得当前任务（进程）的标识
    57 000000C3 0F05                             syscall
    58 000000C5 4989C0                           mov r8, rax
    59 000000C8 488B5DE8                         mov rbx, [rbp-24]
    60 000000CC E82FFFFFFF                       call bin64_to_dec                        ;将进程标识转换为字符串
    61                                  
    62 000000D1 4C8B25(10000000)                 mov r12, [rel linear]                    ;当前程序加载的起始线性地址
    63                                  
    64 000000D8 B800000000                       mov rax, 0                               ;确定当前程序可以使用的显示行
    65 000000DD 0F05                             syscall                                  ;可用显示行，DH=行号
    66                                  
    67 000000DF B200                             mov dl, 0
    68 000000E1 41B10F                           mov r9b, 0x0f
    69                                  
    70 000000E4 41B800000000                     mov r8, 0                                ;R8用于存放累加和
    71 000000EA 41BA01000000                     mov r10, 1                               ;R10用于提供加数
    72                                    .cusum:
    73 000000F0 4D01D0                           add r8, r10
    74 000000F3 488B5DD0                         mov rbx, [rbp-48]
    75 000000F7 E804FFFFFF                       call bin64_to_dec                        ;本次相加的结果转换为字符串
    76                                  
    77 000000FC 4D87C2                           xchg r8, r10
    78 000000FF 488B5DD8                         mov rbx, [rbp-40]
    79 00000103 E8F8FEFFFF                       call bin64_to_dec                        ;本次的加数转换为字符串
    80                                  
    81 00000108 4D87C2                           xchg r8, r10
    82                                  
    83 0000010B B806000000                       mov rax, 6                               ;获得当前处理器的编号
    84 00000110 0F05                             syscall
    85                                  
    86 00000112 4150                             push r8
    87 00000114 4989C0                           mov r8, rax
    88 00000117 488B5DE0                         mov rbx, [rbp-32]
    89 0000011B E8E0FEFFFF                       call bin64_to_dec                        ;将处理器的编号转换为字符串
    90 00000120 4158                             pop r8
    91                                  
    92 00000122 488B7DF8                         mov rdi, [rbp-8]
    93 00000126 C60700                           mov byte [rdi], 0
    94                                  
    95 00000129 498DB424[00000000]               lea rsi, [r12 + tid_prex]
    96 00000131 E812FFFFFF                       call string_concatenates                 ;字符串连接，和strcat相同
    97                                  
    98 00000136 488B75F0                         mov rsi, [rbp-16]
    99 0000013A E809FFFFFF                       call string_concatenates
   100                                  
   101 0000013F 498DB424[08000000]               lea rsi, [r12 + pid_prex]
   102 00000147 E8FCFEFFFF                       call string_concatenates                 ;字符串连接，和strcat相同
   103                                  
   104 0000014C 488B75E8                         mov rsi, [rbp-24]
   105 00000150 E8F3FEFFFF                       call string_concatenates
   106                                  
   107 00000155 498DB424[10000000]               lea rsi, [r12 + cpu_prex]
   108 0000015D E8E6FEFFFF                       call string_concatenates
   109                                  
   110 00000162 488B75E0                         mov rsi, [rbp-32]
   111 00000166 E8DDFEFFFF                       call string_concatenates
   112                                  
   113 0000016B 498DB424[1A000000]               lea rsi, [r12 + delim]
   114 00000173 E8D0FEFFFF                       call string_concatenates
   115                                  
   116 00000178 488B75D8                         mov rsi, [rbp-40]
   117 0000017C E8C7FEFFFF                       call string_concatenates
   118                                  
   119 00000181 498DB424[29000000]               lea rsi, [r12 + equal]
   120 00000189 E8BAFEFFFF                       call string_concatenates
   121                                  
   122 0000018E 488B75D0                         mov rsi, [rbp-48]
   123 00000192 E8B1FEFFFF                       call string_concatenates
   124                                  
   125 00000197 B802000000                       mov rax, 2                               ;在指定坐标显示字符串
   126 0000019C 4889FB                           mov rbx, rdi
   127 0000019F 0F05                             syscall
   128                                  
   129 000001A1 49FFC2                           inc r10
   130 000001A4 4981FA10270000                   cmp r10, 10000;000
   131 000001AB 0F8E3FFFFFFF                     jle .cusum
   132                                  
   133 000001B1 4889EC                           mov rsp, rbp                             ;栈平衡到返回位置
   134 000001B4 C3                               ret
   135                                  
   136                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   137                                  main:
   138 000001B5 488B35(10000000)                 mov rsi, [rel linear]                    ;当前程序加载的起始线性地址
   139                                  
   140 000001BC 488DB6[69000000]                 lea rsi, [rsi + thread_procedure]        ;线程例程的线性地址
   141 000001C3 B807000000                       mov rax, 7                               ;创建线程
   142 000001C8 0F05                             syscall                                  ;创建第一个线程
   143 000001CA 0F05                             syscall                                  ;创建第二个线程
   144                                  
   145 000001CC E898FEFFFF                       call thread_procedure                    ;普通的例程调用（可返回）
   146                                  
   147 000001D1 C3                               ret
   148                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   149                                  start:   ;程序的入口点
   150                                  
   151                                           ;这里放置初始化代码，比如初始化全局数据（变量）
   152                                  
   153 000001D2 E8DEFFFFFF                       call main
   154                                  
   155                                           ;这里放置清理代码
   156                                  
   157 000001D7 B805000000                       mov rax, 5                               ;终止任务
   158 000001DC 0F05                             syscall
   159                                  
   160                                  ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   161                                  app_end:
